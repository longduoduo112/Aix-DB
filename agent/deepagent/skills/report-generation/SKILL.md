---
name: report-generation
description: 生成数据分析报告：查询数据 → 深度分析归因 → 输出 HTML 可视化报告
---

# 报告生成技能

## 何时使用

当用户要求生成**报告、分析报告、可视化报告、趋势分析、统计报告**等任何报告时。

## ⚠️ 约束（不可违反）

- **禁止写入本地文件**
- **禁止调用上传工具**（`upload_html_report_to_minio` 等）
- **HTML 必须用分隔符包裹后直接输出到对话中**
- **此技能是指令文档，直接按流程执行，不要说"调用技能"然后停下**

---

## 工作流程（5 步，必须全部完成）

### 第 1 步：理解需求

从用户诉求中提取：
- **报告类型**：销售、用户、产品、运营、财务等
- **关键指标**：总量、增长率、排名、占比等
- **分析维度**：时间、地区、类别、产品等
- **时间范围**：最近一周/月/年等

### 第 2 步：探索数据库 & 查询数据

1. `sql_db_list_tables` → 找到相关表
2. `sql_db_schema` → 查看列名和类型
3. `sql_db_table_relationship` → 查看表关系
4. `sql_db_query` → 执行查询获取数据

**查询原则：**
- 只查必要列，不用 `SELECT *`
- 使用表别名、适当的 JOIN 条件
- 合理使用聚合函数、GROUP BY、ORDER BY
- 默认 LIMIT 100

### 第 3 步：深度分析（⚠️ 必须执行，不可跳过）

**查询到数据后，必须先分析再生成报告。** 以下 4 个分析维度至少完成 3 个：

#### A. 描述性分析 — What happened

- 计算核心指标：总量、均值、中位数、最大/最小值
- 计算增长率：同比（YoY）、环比（MoM）
- 计算占比：各分类在整体中的比例
- 检测异常值：偏离均值超过 2 倍标准差的数据

#### B. 趋势分析 — How is it changing

- 趋势方向：上升/下降/平稳/波动
- 变化速率：加速还是减速
- 拐点识别：趋势逆转的关键时间点
- 周期性模式：季节性、节假日效应

#### C. 归因分析 — Why did it happen（⚠️ 核心，必须完成）

- **维度下钻**：哪个地区/产品/渠道对变化贡献最大？
- **贡献度量化**：各维度对总体变化的贡献百分比
- **对比归因**：表现优于/低于平均水平的类别及原因
- **结构变化**：各维度占比随时间的迁移

#### D. 对比分析 — How does it compare

- 时间对比：同比、环比
- 分组对比：不同地区/产品/渠道间的差异
- 排名分析：Top N 和 Bottom N
- 帕累托分析：头部集中度（80/20 效应）

### 第 4 步：生成 HTML 报告

报告必须包含以下 **5 个区块**（缺一不可）：

| 区块 | 内容 | 必须 |
|------|------|------|
| **报告标题** | 报告名称 + 时间范围 | ✅ |
| **KPI 统计卡片** | 3-5 个关键指标，带同比/环比变化标识（↑↓） | ✅ |
| **可视化图表** | 至少 2 个 Chart.js 图表（根据数据选择类型） | ✅ |
| **详细数据表格** | 完整数据列表，关键行高亮 | ✅ |
| **分析结论与洞察** | 核心发现 + 归因分析 + 风险提示 + 建议 | ✅ |

**图表类型选择：**
- 时间趋势 → 折线图/面积图
- 类别对比 → 柱状图
- 占比分析 → 饼图/环形图
- 多指标对比 → 组合图（柱状图 + 折线图）
- 排名展示 → 水平柱状图

**"分析结论与洞察"区块必须包含：**

```
📊 核心发现：（每条必须有具体数字）
1. [发现1，带数字]
2. [发现2，带数字]

📈 趋势与归因：
- [驱动因素]：贡献了整体变化的 XX%
- [拖累因素]：导致下降 XX%

⚠️ 风险提示：
- [异常信号或风险点]

💡 建议：
- [短期：具体可操作的建议]
- [中期：具体可操作的建议]
```

**HTML 技术要求：**
- Chart.js via CDN：`https://cdn.jsdelivr.net/npm/chart.js`
- Google Fonts：Inter（正文）+ Playfair Display（标题）
- CSS 变量实现浅色/深色模式（`prefers-color-scheme: dark`）
- 响应式设计，卡片布局，间距一致
- 配色专业（蓝色系为主），对比度 ≥ 4.5:1
- 不使用 emoji 作为图标

### 第 5 步：输出报告

用分隔符包裹 HTML 直接输出：

```
根据查询结果，为您生成数据分析报告：

<!-- REPORT_HTML_START -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>...</head>
<body>...</body>
</html>
<!-- REPORT_HTML_END -->

**报告已生成完毕**，包含：
- [图表1说明]
- [图表2说明]
- 详细数据表格
- 分析结论与洞察

您可以点击「预览报告」查看，或点击「下载报告」保存到本地。
```

**关键：**
- 分隔符必须独占一行
- HTML 必须完整（DOCTYPE + html + head + body）
- 查询数据后必须立即生成报告，不要中途停顿

---

## 常见报告模式速查

| 模式 | 查询策略 | 推荐图表 |
|------|---------|---------|
| 时间趋势 | DATE_TRUNC + GROUP BY 月份 | 折线图 |
| 类别对比 | GROUP BY 类别 + ORDER BY | 柱状图 |
| Top N 排名 | ORDER BY DESC LIMIT N | 水平柱状图 |
| 占比分析 | GROUP BY + 百分比计算 | 饼图/环形图 |
| 增长率分析 | 窗口函数 LAG() | 折线图 + 数据标签 |
| 归因分解 | 多维度 GROUP BY + 增量贡献 | 瀑布图/堆叠柱状图 |
| 异常检测 | 均值 ± 2σ 标记异常 | 折线图 + 红色标注 |
| 帕累托分析 | 累积占比计算 | 组合图（柱状 + 累积线） |
